
# ğŸ§  Multiperturbation Shapley Value Analysis (MSA) å…¨é¢ç¬”è®°

---

## ğŸ“Œ 1. MSA çš„æ ¸å¿ƒç›®æ ‡

> åˆ©ç”¨ Shapley å€¼ï¼Œè¯„ä¼°æ¯ä¸ªè„‘åŒºå¯¹è¡Œä¸ºè¡¨ç°ï¼ˆå¦‚ FMAï¼‰çš„â€œè¾¹é™…è´¡çŒ®â€ï¼Œè¯†åˆ«å…³é”®åŠŸèƒ½è„‘åŒºã€‚

---

## ğŸ“Š 2. æ•°æ®è¾“å…¥ç»“æ„

```matlab
xy = [X, y];
```

- `X`: æ¯ä¸€è¡Œä¸ºä¸€ä¸ªå—è¯•è€…ï¼Œåˆ—ä¸ºå„ä¸ªè„‘åŒºæŸä¼¤ç¨‹åº¦ï¼ˆZ å€¼ï¼Œ0~1ï¼‰
- `y`: è¡Œä¸ºåˆ†æ•°ï¼ˆå¦‚ FMAï¼‰ï¼Œæ•°å€¼è¶Šé«˜åŠŸèƒ½è¶Šå¥½
- `X_i = 1 - Z_i`ï¼šè„‘åŒºåŠŸèƒ½ä¿ç•™åº¦

---

## âš™ï¸ 3. æ ¸å¿ƒå‡½æ•°å…¥å£

```matlab
[SV, Calib, coal, Bset, Lset] = PerformMSA(xy, pdepth, nBS, alpha, TOP);
```

- `pdepth`: æœ€å¤§æ‰°åŠ¨ç»„åˆå¤§å°ï¼ˆå¦‚è®¾ç½®ä¸º 5ï¼Œè¯„ä¼°1~5ä¸ªè„‘åŒºç»„åˆï¼‰
- `nBS`: bootstrap æ¬¡æ•°ï¼ˆ>0 è§¦å‘ç»Ÿè®¡æ¨æ–­ï¼‰
- `TOP`: å¥åº·è¢«è¯•è¡Œä¸ºè¯„åˆ†ä¸Šé™ï¼ˆå¦‚ FMA=66ï¼‰

---

## ğŸ§  4. Shapley å€¼çš„å®šä¹‰ä¸è¿‘ä¼¼

Shapley å€¼åŸå§‹å®šä¹‰ï¼ˆåˆä½œåšå¼ˆè®ºï¼‰ï¼š

$$
\phi_i = \sum_{S \subseteq N \setminus \{i\}} \frac{|S|!(|N|-|S|-1)!}{|N|!} \cdot (v(S \cup \{i\}) - v(S))
$$

ç”±äºç»„åˆæ•°æŒ‡æ•°çº§å¢é•¿ï¼ŒMSA ä½¿ç”¨ **Potentials method** è¿‘ä¼¼ï¼š

$$
\phi_i \approx \sum_{k=1}^{pdepth} \frac{1}{k} \cdot \left( \mathbb{E}[v_k(i)] - \mathbb{E}[v_k] \right) + \text{offset}
$$

- $\mathbb{E}[v_k(i)]$: æ‰€æœ‰å¤§å°ä¸º k ä¸”åŒ…å« i çš„ç»„åˆçš„å¹³å‡é¢„æµ‹å€¼  
- $\mathbb{E}[v_k]$: æ‰€æœ‰å¤§å°ä¸º k çš„ç»„åˆçš„å¹³å‡é¢„æµ‹å€¼

---

## ğŸ§ª 5. è¡Œä¸ºé¢„æµ‹ç›®æ ‡å‡½æ•°ï¼ˆç›®æ ‡å‡½æ•°ï¼‰

é»˜è®¤é¢„æµ‹å™¨ä¸ºï¼š

$$v(S) = \sum_j w_j^{(S)} \cdot y_j, \quad w_j = \exp(-b \cdot d_j)$$

- `ApplyPredictor` å‡½æ•°å®ç°æ ¸åŠ æƒå¹³å‡
- `b_param`: æ§åˆ¶è·ç¦»è¡°å‡ï¼Œé»˜è®¤ 15ï¼ˆè¶Šå¤§è¶Šå±€éƒ¨ï¼‰

---

## ğŸ“ˆ 6. Shapley å€¼è®¡ç®—ä»£ç ä½ç½®

åœ¨ `Compute_ShapleyVector_Bound.m` ä¸­æ ¸å¿ƒç‰‡æ®µï¼š

```matlab
VVest(nR, region) = mean(Vest{nR}(indices));       % E[v_k(i)]
meanest(nR) = mean(pre1SHest(nR,:));               % E[v_k]
SHest(j,:) = TOP/m + pre1SHest(j,:) - meanest(j);  % æœ€ç»ˆ Shapley å€¼
```

---

## ğŸ“Š 7. ç»Ÿè®¡æ˜¾è‘—æ€§æ£€éªŒ

ä½¿ç”¨ bootstrap æˆ– leave-one-out ç”Ÿæˆï¼š

- `pvalestmix`: æ¯ä¸ªè„‘åŒºçš„ p å€¼
- `pvalestFDRmix`: FDR æ ¡æ­£åçš„ p å€¼
- `CIcalibmixSHAPL`: ç½®ä¿¡åŒºé—´ + SV å€¼ï¼Œä¾¿äºç»˜å›¾

æ˜¾è‘—æ€§åˆ¤æ–­æ–¹æ³•ï¼š
- p < 0.05
- ç½®ä¿¡åŒºé—´ä¸è·¨ 0

---

## ğŸ“Œ 8. å¯è§†åŒ–å‡½æ•° `plotSV`

```matlab
plotSV(Bset, calib, fdr_flag, large_only_flag, alpha, RegionNames)
```

- æ˜¾ç¤º SVã€è¯¯å·®æ¡ã€æ˜¾è‘—æ ‡è®° `*`ã€æœªæ ¡æ­£æ˜¾è‘—æ€§ `o`

---

## ğŸ” 9. åˆ†ææŸè„‘åŒºä¸å…¶ä»–è„‘åŒºçš„äº¤äº’

æŸ¥æ‰¾å«æŸè„‘åŒº i çš„æ‰€æœ‰ç»„åˆï¼š

```matlab
idx = find(any(coal.Coal{p} == i, 2));
```

ç»Ÿè®¡ä¸å…¶å…±åŒå‡ºç°é¢‘ç‡ï¼Œæ„å»ºäº¤äº’çƒ­å›¾æˆ–ç½‘ç»œå›¾ã€‚

---

## âœ… æ€»ç»“

MSA ç”¨è¿‘ä¼¼ Shapley å€¼æ–¹æ³•ï¼Œåœ¨ä¸´åºŠè¡Œä¸ºæ•°æ®ä¸­å®šä½å…³é”®è„‘åŒºï¼š

- ç›®æ ‡å‡½æ•°ï¼šv(S) ä¸ºç»„åˆ S çš„è¡Œä¸ºé¢„æµ‹å€¼
- Shapley å€¼ï¼šæœŸæœ›è¾¹é™…è´¡çŒ®
- Potentials methodï¼šé«˜æ•ˆä¼°ç®—
- Bootstrap/LOOï¼šæ¨æ–­ç¨³å®šæ€§å’Œæ˜¾è‘—æ€§
